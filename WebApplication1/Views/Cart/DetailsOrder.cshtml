@model WebApplication1.Entities.Order
@using WebApplication1.Entities

@{
    ViewData["Title"] = "Order Details";
    var rows = Model?.OrderDetails ?? Enumerable.Empty<OrderDetail>();
    decimal total = rows.Sum(od => od.Qty * od.Price);
    decimal cash = Model?.cashAmount ?? 0m;
    decimal change = (Model?.cashreturn) ?? (cash > 0 ? cash - total : 0m);

    string F(decimal v) => v.ToString("N2");
    string Barcode(OrderDetail od) => od.Product?.CodeOrBarcode ?? od.Product?.CodeOrBarcode ?? "—";
    string PName(OrderDetail od) => od.Product?.Name ?? od.Product?.Name ?? "Unknown";
}

<style>
    /* Boost contrast for dark themes */
    .order-table thead th {
        border-bottom: 2px solid rgba(255,255,255,.2) !important;
    }

    .order-table tbody td {
        border-color: rgba(255,255,255,.08) !important;
    }

    .order-table tfoot th {
        border-top: 2px solid rgba(255,255,255,.25) !important;
    }

    .num {
        text-align: right;
        white-space: nowrap;
    }

    .w-idx {
        width: 56px;
    }

    .w-bar {
        min-width: 140px;
    }

    .w-qty {
        width: 96px;
    }

    .w-price {
        width: 120px;
    }

    .w-sub {
        width: 140px;
    }

    .totals-row th {
        font-weight: 600;
    }
</style>

<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Order #@Model.Id</h4>
        <div class="text-secondary">
            <small>
                Date: @(Model.OrderDate?.ToString("yyyy-MM-dd HH:mm") ?? "—") ·
                Status: @Model.Status
            </small>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-sm table-dark order-table align-middle">
            <thead>
                <tr>
                    <th class="w-idx">#</th>
                    <th class="w-bar">Barcode</th>
                    <th>Product</th>
                    <th class="w-qty num">Qty</th>
                    <th class="w-price num">Price</th>
                    <th class="w-sub num">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                @if (!rows.Any())
                {
                    <tr><td colspan="6" class="text-center text-secondary py-4">No items.</td></tr>
                }
                else
                {
                    var i = 1;
                    foreach (var od in rows)
                    {
                        var sub = od.Qty * od.Price;
                        <tr>
                            <td>@(i++)</td>
                            <td>@Barcode(od)</td>
                            <td>@PName(od)</td> @* not muted so it’s readable *@
                            <td class="num">@od.Qty</td>
                            <td class="num">@F(od.Price)</td>
                            <td class="num fw-semibold">@F(sub)</td>
                        </tr>
                    }
                }
            </tbody>
            <tfoot>
                <tr class="totals-row">
                    <th colspan="5" class="text-end">Total (សរុប)</th>
                    <th class="num">@F(total)</th>
                </tr>
                <tr>
                    <th colspan="5" class="text-end">Cash (ប្រាក់បានទទួល)</th>
                    <th class="num">@F(cash)</th>
                </tr>
                <tr>
                    <th colspan="5" class="text-end">Change (អាប់ប្រាក់)</th>
                    <th class="num">@F(change)</th>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="d-flex gap-2 mt-3">
        <a asp-action="Index" asp-controller="Cart" class="btn btn-outline-secondary">Back</a>

        @if (Model.cashAmount < 0)   // ✅ បង្ហាញប៊ូតុង Payment តែពេល Cash មាន
        {
            <a asp-action="Invoice"
               asp-controller="Cart"
               asp-route-orderId="@Model.Id"
               class="btn btn-outline-secondary">Payment</a>
        }
        else
        {
           

            <a asp-action="Invoice"
               asp-controller="Cart"
               asp-route-id="@Model.Id"
               asp-route-receipt="true"
               asp-route-change="@(Convert.ToDecimal(Model.cashreturn))"
               target="_blank"
               rel="noopener noreferrer"
               class="btn btn-outline-info w-50">
                Print
            </a>
        }
    </div>

</div>

@section Scripts {
    <script>
        document.getElementById('btnPrint')?.addEventListener('click', function () {
            // Warn if cash not set
            var cash = '@cash';
            if (!cash || cash === '0') {
                alert('សូមបញ្ចូល Cash Amount មុនព្រីនវិក្កយបត្រ (please enter cash amount before printing).');
                return;
            }
            window.print();
        });
    </script>
}
